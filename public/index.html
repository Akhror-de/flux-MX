<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flux Integration Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .test-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .test-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }
        
        .test-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .test-icon {
            font-size: 24px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .test-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .test-desc {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 20px;
        }
        
        .test-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .test-input:focus {
            outline: none;
            border-color: #00d4ff;
            background: white;
        }
        
        .test-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(45deg, #00d4ff, #008cff);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 132, 255, 0.3);
        }
        
        .test-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .test-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            overflow-x: auto;
            display: none;
        }
        
        .test-success {
            display: block;
            border-left: 4px solid #00c853;
        }
        
        .test-error {
            display: block;
            border-left: 4px solid #ff2d55;
        }
        
        .api-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-checking {
            background: #ffaa00;
            animation: pulse 1.5s infinite;
        }
        
        .status-online {
            background: #00c853;
            box-shadow: 0 0 10px #00c853;
        }
        
        .status-offline {
            background: #ff2d55;
        }
        
        .console {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .console-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-time {
            color: #00d4ff;
            margin-right: 10px;
        }
        
        .log-success {
            color: #00c853;
        }
        
        .log-error {
            color: #ff2d55;
        }
        
        .log-info {
            color: #0084ff;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Flux Integration Test</h1>
            <p>Test the connection between frontend and Yandex Cloud functions</p>
        </div>
        
        <div class="api-status" id="api-status">
            <div class="status-indicator status-checking" id="status-indicator"></div>
            <span id="status-text">Checking API...</span>
        </div>
        
        <div class="test-grid">
            <!-- Test 1: API Health -->
            <div class="test-card">
                <div class="test-header">
                    <div class="test-icon">ü©∫</div>
                    <div class="test-title">API Health Check</div>
                </div>
                <div class="test-desc">
                    Test if the Yandex Cloud function is reachable
                </div>
                <button class="test-btn" onclick="testHealth()" id="health-btn">
                    <span>Run Health Check</span>
                </button>
                <div class="test-result" id="health-result"></div>
            </div>
            
            <!-- Test 2: URL Analysis -->
            <div class="test-card">
                <div class="test-header">
                    <div class="test-icon">üîó</div>
                    <div class="test-title">URL Analysis Test</div>
                </div>
                <div class="test-desc">
                    Analyze audio from a URL (Mixkit sample)
                </div>
                <input type="text" 
                       class="test-input" 
                       id="test-url"
                       value="https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-130.mp3"
                       placeholder="Enter audio URL">
                <button class="test-btn" onclick="testAnalyze()" id="analyze-btn">
                    <span>Analyze Audio</span>
                </button>
                <div class="test-result" id="analyze-result"></div>
            </div>
            
            <!-- Test 3: Cache Test -->
            <div class="test-card">
                <div class="test-header">
                    <div class="test-icon">üíæ</div>
                    <div class="test-title">Cache Test</div>
                </div>
                <div class="test-desc">
                    Test API service caching mechanism
                </div>
                <button class="test-btn" onclick="testCache()" id="cache-btn">
                    <span>Test Cache</span>
                </button>
                <div class="test-result" id="cache-result"></div>
            </div>
            
            <!-- Test 4: Recommendations -->
            <div class="test-card">
                <div class="test-header">
                    <div class="test-icon">üí°</div>
                    <div class="test-title">Recommendations Test</div>
                </div>
                <div class="test-desc">
                    Generate mixing recommendations
                </div>
                <button class="test-btn" onclick="testRecommendations()" id="rec-btn">
                    <span>Get Recommendations</span>
                </button>
                <div class="test-result" id="recommendations-result"></div>
            </div>
        </div>
        
        <!-- Console -->
        <div class="console">
            <div class="console-title">
                <span>üìã Test Console</span>
            </div>
            <div id="console-output"></div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="api-service.js"></script>
    
    <script>
        // Global variables
        let api;
        const consoleOutput = document.getElementById('console-output');
        const startTime = new Date();
        
        // Initialize API service
        document.addEventListener('DOMContentLoaded', () => {
            try {
                api = new FluxApiService();
                log('üåê Flux API Service initialized', 'info');
                log(`Endpoints: ${JSON.stringify(api.config.ENDPOINTS)}`, 'info');
                
                // Initial health check
                testHealth();
                
            } catch (error) {
                log(`‚ùå Failed to initialize API: ${error.message}`, 'error');
            }
        });
        
        // Log to console
        function log(message, type = 'info') {
            const time = new Date();
            const timeStr = time.toLocaleTimeString();
            const elapsed = Math.round((time - startTime) / 1000);
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            let colorClass = 'log-info';
            if (type === 'success') colorClass = 'log-success';
            if (type === 'error') colorClass = 'log-error';
            
            entry.innerHTML = `
                <span class="log-time">[+${elapsed}s]</span>
                <span class="${colorClass}">${message}</span>
            `;
            
            consoleOutput.appendChild(entry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            // Also log to browser console
            console[type === 'error' ? 'error' : 'log'](message);
        }
        
        // Update API status
        function updateApiStatus(isHealthy) {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            
            indicator.className = `status-indicator ${isHealthy ? 'status-online' : 'status-offline'}`;
            text.textContent = isHealthy ? 'API Online' : 'API Offline';
        }
        
        // Test 1: Health Check
        async function testHealth() {
            const btn = document.getElementById('health-btn');
            const result = document.getElementById('health-result');
            
            btn.disabled = true;
            btn.innerHTML = '<span>Checking...</span>';
            result.className = 'test-result';
            
            try {
                log('ü©∫ Starting health check...', 'info');
                
                const isHealthy = await api.config.healthCheck();
                
                if (isHealthy) {
                    result.innerHTML = `<pre>‚úÖ API is healthy and reachable</pre>`;
                    result.className = 'test-result test-success';
                    log('‚úÖ Health check passed', 'success');
                } else {
                    result.innerHTML = `<pre>‚ö†Ô∏è API returned unhealthy status</pre>`;
                    result.className = 'test-result test-error';
                    log('‚ö†Ô∏è Health check returned unhealthy', 'error');
                }
                
                updateApiStatus(isHealthy);
                
            } catch (error) {
                result.innerHTML = `<pre>‚ùå Health check failed: ${error.message}</pre>`;
                result.className = 'test-result test-error';
                log(`‚ùå Health check failed: ${error.message}`, 'error');
                updateApiStatus(false);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Run Health Check</span>';
            }
        }
        
        // Test 2: Analyze URL
        async function testAnalyze() {
            const btn = document.getElementById('analyze-btn');
            const result = document.getElementById('analyze-result');
            const url = document.getElementById('test-url').value;
            
            btn.disabled = true;
            btn.innerHTML = '<span>Analyzing...</span>';
            result.className = 'test-result';
            
            try {
                log(`üîó Starting analysis for: ${url.substring(0, 50)}...`, 'info');
                
                const analysis = await api.analyzeAudio(url);
                
                result.innerHTML = `<pre>‚úÖ Analysis successful!\n\n${JSON.stringify(analysis, null, 2)}</pre>`;
                result.className = 'test-result test-success';
                
                log(`‚úÖ Analysis complete: ${analysis.bpm} BPM in ${analysis.key}`, 'success');
                
            } catch (error) {
                result.innerHTML = `<pre>‚ùå Analysis failed: ${error.message}</pre>`;
                result.className = 'test-result test-error';
                log(`‚ùå Analysis failed: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Analyze Audio</span>';
            }
        }
        
        // Test 3: Cache Test
        async function testCache() {
            const btn = document.getElementById('cache-btn');
            const result = document.getElementById('cache-result');
            const url = 'https://assets.mixkit.co/music/preview/mixkit-deep-urban-623.mp3';
            
            btn.disabled = true;
            btn.innerHTML = '<span>Testing...</span>';
            result.className = 'test-result';
            
            try {
                log('üíæ Starting cache test...', 'info');
                
                // First request
                log('Request 1: Uncached', 'info');
                const start1 = Date.now();
                const result1 = await api.analyzeAudio(url);
                const time1 = Date.now() - start1;
                
                // Second request (should be cached)
                log('Request 2: Should be cached', 'info');
                const start2 = Date.now();
                const result2 = await api.analyzeAudio(url);
                const time2 = Date.now() - start2;
                
                // Check if cached
                const history = api.getRequestHistory();
                const cachedEntry = history.find(h => h.data.bpm === result1.bpm);
                
                result.innerHTML = `<pre>‚úÖ Cache test successful!\n\n` +
                    `First request: ${time1}ms\n` +
                    `Second request: ${time2}ms\n` +
                    `Cached: ${cachedEntry ? 'Yes' : 'No'}\n` +
                    `Speed improvement: ${((time1 - time2) / time1 * 100).toFixed(0)}%\n` +
                    `Cache entries: ${history.length}</pre>`;
                result.className = 'test-result test-success';
                
                log(`‚úÖ Cache test complete: ${time1}ms ‚Üí ${time2}ms`, 'success');
                
            } catch (error) {
                result.innerHTML = `<pre>‚ùå Cache test failed: ${error.message}</pre>`;
                result.className = 'test-result test-error';
                log(`‚ùå Cache test failed: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Test Cache</span>';
            }
        }
        
        // Test 4: Recommendations
        async function testRecommendations() {
            const btn = document.getElementById('rec-btn');
            const result = document.getElementById('recommendations-result');
            
            btn.disabled = true;
            btn.innerHTML = '<span>Generating...</span>';
            result.className = 'test-result';
            
            try {
                log('üí° Generating recommendations...', 'info');
                
                // First get analysis
                const url = 'https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-130.mp3';
                const analysis = await api.analyzeAudio(url);
                
                // Then get recommendations
                const recommendations = await api.getRecommendations(analysis);
                
                const tipsHtml = recommendations.mixingTips?.map(tip => `‚Ä¢ ${tip}`).join('\n') || 'No tips';
                const tracksHtml = recommendations.compatibleTracks?.map(t => 
                    `  - ${t.title} by ${t.artist} (${t.bpm} BPM, ${t.key})`
                ).join('\n') || 'No tracks';
                
                result.innerHTML = `<pre>‚úÖ Recommendations generated!\n\n` +
                    `=== Mixing Tips ===\n${tipsHtml}\n\n` +
                    `=== Compatible Tracks ===\n${tracksHtml}\n\n` +
                    `Energy match: ${recommendations.energyMatch}\n` +
                    `Next key: ${recommendations.suggestedNextKey}</pre>`;
                result.className = 'test-result test-success';
                
                log(`‚úÖ Recommendations generated with ${recommendations.mixingTips?.length || 0} tips`, 'success');
                
            } catch (error) {
                result.innerHTML = `<pre>‚ùå Recommendations failed: ${error.message}</pre>`;
                result.className = 'test-result test-error';
                log(`‚ùå Recommendations failed: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Get Recommendations</span>';
            }
        }
        
        // Auto-run tests on load
        setTimeout(() => {
            log('üöÄ Starting integration tests...', 'info');
        }, 1000);
    </script>
</body>
</html>
